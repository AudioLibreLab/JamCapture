<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JamCapture - Mix</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* Navigation header */
        .nav-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: var(--pico-border-radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .nav-title {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--pico-border-radius);
            transition: background-color 0.3s ease;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Mix interface styles */
        .mix-controls {
            margin-bottom: 2rem;
        }

        .file-selector {
            margin-bottom: 1.5rem;
        }

        .file-info {
            background: var(--pico-card-background-color);
            padding: 1rem;
            border-radius: var(--pico-border-radius);
            border: 1px solid var(--pico-border-color);
            margin-bottom: 1.5rem;
        }

        .track-mixer {
            display: none; /* Initially hidden until file is selected */
            margin-bottom: 2rem;
        }

        .track-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .track-item {
            background: var(--pico-card-background-color);
            border: 2px solid var(--pico-border-color);
            border-radius: var(--pico-border-radius);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .track-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--pico-color-primary);
            margin: 0;
        }

        .track-channels {
            font-size: 0.9rem;
            color: var(--pico-muted-color);
        }

        .volume-control {
            margin-bottom: 1rem;
        }

        .volume-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--pico-color-primary-background);
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0; /* Add margin to prevent clipping */
        }

        /* WebKit browsers (Chrome, Safari, Edge) */
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--pico-color-primary);
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            background: var(--pico-color-primary-hover);
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        /* Firefox */
        .volume-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--pico-color-primary);
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .volume-slider::-moz-range-thumb:hover {
            background: var(--pico-color-primary-hover);
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        /* Track styles for consistency */
        .volume-slider::-webkit-slider-track {
            background: var(--pico-color-primary-background);
            border-radius: 4px;
            height: 8px;
        }

        .volume-slider::-moz-range-track {
            background: var(--pico-color-primary-background);
            border-radius: 4px;
            height: 8px;
            border: none;
        }

        .volume-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .volume-value {
            font-weight: bold;
            color: var(--pico-color-primary);
            min-width: 60px;
            text-align: right;
        }

        .volume-presets {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .preset-btn {
            background: var(--pico-color-secondary);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: var(--pico-border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s ease;
        }

        .preset-btn:hover {
            background: var(--pico-color-secondary-hover);
        }

        .mix-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .mix-button {
            background: var(--pico-color-success);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--pico-border-radius);
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .mix-button:hover {
            background: var(--pico-color-success-hover);
            transform: translateY(-1px);
        }

        .mix-button:disabled {
            background: var(--pico-color-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .reset-button {
            background: var(--pico-color-warning);
        }

        .reset-button:hover {
            background: var(--pico-color-warning-hover);
        }

        /* Audio player section */
        .audio-player-section {
            background: var(--pico-card-background-color);
            border: 1px solid var(--pico-border-color);
            border-radius: var(--pico-border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .audio-player-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--pico-color-primary);
        }

        .player-controls {
            width: 100%;
        }

        .audio-player-container {
            background: var(--pico-background-color);
            border: 1px solid var(--pico-border-color);
            border-radius: var(--pico-border-radius);
            padding: 1rem;
        }

        .player-status {
            margin-bottom: 1rem;
            font-style: italic;
            color: var(--pico-muted-color);
        }

        .custom-audio-player {
            width: 100%;
            margin-bottom: 1rem;
        }

        .file-info {
            font-size: 0.9rem;
            color: var(--pico-muted-color);
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--pico-border-color);
        }

        /* MKV Browser Section */
        .mkv-browser-section {
            background: var(--pico-card-background-color);
            border: 1px solid var(--pico-border-color);
            border-radius: var(--pico-border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .mkv-browser-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--pico-color-primary);
        }

        /* Recordings/MKV list styles */
        .recordings-controls {
            margin-bottom: 1.5rem;
        }

        .search-sort-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .recordings-search-input {
            flex: 1;
            margin: 0;
        }

        .recordings-sort-select {
            min-width: 150px;
            margin: 0;
        }

        .recordings-list-container {
            position: relative;
        }

        .recordings-status {
            text-align: center;
            padding: 2rem;
            color: var(--pico-muted-color);
            font-style: italic;
        }

        .recordings-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .recording-item {
            background: var(--pico-background-color);
            border: 1px solid var(--pico-border-color);
            border-radius: var(--pico-border-radius);
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .recording-item:hover {
            border-color: var(--pico-color-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .recording-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }

        .recording-info {
            font-size: 0.85rem;
            color: var(--pico-muted-color);
            margin-bottom: 0.5rem;
        }

        .recording-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .recording-actions button {
            flex: 1;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .recordings-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--pico-border-color);
        }

        .pagination-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.9rem;
            color: var(--pico-muted-color);
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .hidden {
            display: none !important;
        }

        /* Response messages */
        .response-area {
            margin-bottom: 2rem;
        }

        .alert {
            padding: 1rem;
            border-radius: var(--pico-border-radius);
            margin-bottom: 1rem;
        }

        .alert-success {
            background-color: var(--pico-color-success-background);
            border: 1px solid var(--pico-color-success);
            color: var(--pico-color-success);
        }

        .alert-error {
            background-color: var(--pico-color-danger-background);
            border: 1px solid var(--pico-color-danger);
            color: var(--pico-color-danger);
        }

        .alert-info {
            background-color: var(--pico-color-primary-background);
            border: 1px solid var(--pico-color-primary);
            color: var(--pico-color-primary);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--pico-muted-color);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .nav-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .track-list {
                grid-template-columns: 1fr;
            }

            .mix-actions {
                flex-direction: column;
                align-items: center;
            }

            .track-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div class="nav-header">
        <div class="nav-content">
            <a href="/" class="nav-title">üé∏ JamCapture</a>
            <div class="nav-links">
                <a href="/" class="nav-link">üè† Recording</a>
                <a href="/config" class="nav-link">‚öôÔ∏è Configuration</a>
                <a href="/mix" class="nav-link active">üéõÔ∏è Mix</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Page Header -->
        <header>
            <h1>üéõÔ∏è Mix Interface</h1>
            <p>Select an MKV file, adjust individual track volumes, and create custom mixes.</p>
        </header>

        <!-- Response Area -->
        <div id="response-area" class="response-area"></div>

        <!-- Audio Player Section (Top) -->
        <div class="audio-player-section">
            <h3>üéß Mix Player</h3>

            <div class="player-controls">
                <!-- Audio Player Container -->
                <div class="audio-player-container">
                    <div id="player-status" class="player-status">
                        Loading last mixed file...
                    </div>
                    <audio id="audio-player" class="custom-audio-player hidden" controls preload="metadata">
                        Your browser does not support the audio element.
                    </audio>
                    <div id="audio-error" class="hidden" style="color: var(--pico-color-danger); margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    <div id="file-info-player" class="file-info hidden"></div>
                </div>
            </div>
        </div>

        <!-- Track Mixer Controls (Middle) -->
        <div id="track-mixer" class="track-mixer">
            <h3>üéöÔ∏è Track Mixer</h3>
            <div id="track-list" class="track-list">
                <!-- Track controls will be dynamically inserted here -->
            </div>

            <!-- Mix Actions -->
            <div class="mix-actions">
                <button id="reset-button" class="mix-button reset-button" onclick="resetVolumes()">üîÑ Reset Volumes</button>
                <button id="mix-button" class="mix-button" onclick="createMix()">üéõÔ∏è Create Mix</button>
            </div>
        </div>

        <!-- MKV File Browser Section (Bottom) -->
        <div class="mkv-browser-section">
            <h3>üìÅ MKV File Browser</h3>

            <div class="recordings-controls">
                <div class="search-sort-bar">
                    <input type="text" id="mkv-search" placeholder="üîç Search MKV files..." class="recordings-search-input">
                    <select id="mkv-sort" class="recordings-sort-select">
                        <option value="date_desc">üìÖ Newest first</option>
                        <option value="date_asc">üìÖ Oldest first</option>
                        <option value="name_asc">üî§ Name A‚ÜíZ</option>
                        <option value="name_desc">üî§ Name Z‚ÜíA</option>
                    </select>
                </div>
            </div>

            <div class="recordings-list-container">
                <div id="mkv-status" class="recordings-status">
                    Loading MKV files...
                </div>
                <div id="mkv-list" class="recordings-list hidden">
                    <!-- MKV files will be populated by JavaScript -->
                </div>
                <div id="mkv-pagination" class="recordings-pagination hidden">
                    <div class="pagination-info">
                        <span id="mkv-pagination-info">Page 1 of 1</span>
                        <span id="mkv-total-info">(0 MKV files)</span>
                    </div>
                    <div class="pagination-controls">
                        <button id="mkv-prev" class="pagination-btn" onclick="previousMKVPage()" disabled>‚Äπ Previous</button>
                        <button id="mkv-next" class="pagination-btn" onclick="nextMKVPage()" disabled>Next ‚Ä∫</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let selectedFile = null;
        let trackAnalysis = null;
        let trackVolumes = {};

        // MKV files pagination state
        let allMKVFiles = [];
        let filteredMKVFiles = [];
        let currentPage = 1;
        let itemsPerPage = 12;
        let searchQuery = '';
        let currentSort = 'date_desc';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadLastMixedFile();
            loadMKVFiles();
            setupMKVEventListeners();
        });

        // Load last mixed file and set up player
        function loadLastMixedFile() {
            fetch('/api/mix/last-mixed')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.last_mixed_file && data.exists) {
                        setupAudioPlayer(data.last_mixed_file, data);
                    } else {
                        document.getElementById('player-status').textContent = 'No recent mixes found';
                    }
                })
                .catch(error => {
                    console.error('Failed to load last mixed file:', error);
                    document.getElementById('player-status').textContent = 'Error loading last mix';
                });
        }

        // Set up audio player with file
        function setupAudioPlayer(filename, fileInfo) {
            const playerStatus = document.getElementById('player-status');
            const audioPlayer = document.getElementById('audio-player');
            const fileInfoDiv = document.getElementById('file-info-player');

            playerStatus.textContent = `Last Mixed: ${filename}`;
            audioPlayer.src = `/api/mix/stream/${encodeURIComponent(filename)}`;
            audioPlayer.classList.remove('hidden');

            if (fileInfo) {
                fileInfoDiv.innerHTML = `
                    <strong>File:</strong> ${filename}<br>
                    <strong>Size:</strong> ${fileInfo.size_human || ''}<br>
                    <strong>Modified:</strong> ${fileInfo.mod_time || ''}
                `;
                fileInfoDiv.classList.remove('hidden');
            }
        }

        // Load available MKV files
        function loadMKVFiles() {
            document.getElementById('mkv-status').textContent = 'Loading MKV files...';

            fetch('/api/mix/files')
                .then(response => response.json())
                .then(data => {
                    if (data.files && data.files.length > 0) {
                        allMKVFiles = data.files;
                        filterAndSortMKVFiles();
                        renderMKVList();
                    } else {
                        document.getElementById('mkv-status').textContent = 'No MKV files found';
                        document.getElementById('mkv-list').classList.add('hidden');
                        document.getElementById('mkv-pagination').classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('Failed to load MKV files:', error);
                    document.getElementById('mkv-status').textContent = 'Error loading MKV files';
                });
        }

        // Setup event listeners for MKV search and sort
        function setupMKVEventListeners() {
            const searchInput = document.getElementById('mkv-search');
            const sortSelect = document.getElementById('mkv-sort');

            searchInput.addEventListener('input', handleMKVSearch);
            sortSelect.addEventListener('change', handleMKVSort);
        }

        // Handle MKV search input
        function handleMKVSearch(event) {
            searchQuery = event.target.value.toLowerCase();
            currentPage = 1; // Reset to first page
            filterAndSortMKVFiles();
            renderMKVList();
        }

        // Handle MKV sort change
        function handleMKVSort(event) {
            currentSort = event.target.value;
            currentPage = 1; // Reset to first page
            filterAndSortMKVFiles();
            renderMKVList();
        }

        // Filter and sort MKV files based on search and sort criteria
        function filterAndSortMKVFiles() {
            // Filter by search query
            filteredMKVFiles = allMKVFiles.filter(file => {
                return file.name.toLowerCase().includes(searchQuery);
            });

            // Sort the filtered results
            filteredMKVFiles.sort((a, b) => {
                switch (currentSort) {
                    case 'date_asc':
                        return new Date(a.mod_time) - new Date(b.mod_time);
                    case 'date_desc':
                        return new Date(b.mod_time) - new Date(a.mod_time);
                    case 'name_asc':
                        return a.name.localeCompare(b.name);
                    case 'name_desc':
                        return b.name.localeCompare(a.name);
                    default:
                        return 0;
                }
            });
        }

        // Render MKV files list with pagination
        function renderMKVList() {
            const mkvList = document.getElementById('mkv-list');
            const mkvStatus = document.getElementById('mkv-status');
            const mkvPagination = document.getElementById('mkv-pagination');

            if (filteredMKVFiles.length === 0) {
                mkvStatus.textContent = searchQuery ? 'No matching MKV files found' : 'No MKV files found';
                mkvList.classList.add('hidden');
                mkvPagination.classList.add('hidden');
                return;
            }

            // Hide status, show list
            mkvStatus.classList.add('hidden');
            mkvList.classList.remove('hidden');
            mkvPagination.classList.remove('hidden');

            // Calculate pagination
            const totalPages = Math.ceil(filteredMKVFiles.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredMKVFiles.length);
            const currentFiles = filteredMKVFiles.slice(startIndex, endIndex);

            // Render files
            mkvList.innerHTML = '';
            currentFiles.forEach(file => {
                const fileElement = createMKVFileElement(file);
                mkvList.appendChild(fileElement);
            });

            // Update pagination
            updateMKVPagination(currentPage, totalPages, filteredMKVFiles.length);
        }

        // Create MKV file element
        function createMKVFileElement(file) {
            const div = document.createElement('div');
            div.className = 'recording-item';

            div.innerHTML = `
                <div class="recording-name">${file.name}</div>
                <div class="recording-info">
                    Size: ${file.size_human}<br>
                    Modified: ${new Date(file.mod_time).toLocaleDateString()}
                </div>
                <div class="recording-actions">
                    <button onclick="selectMKVFile('${file.name}')" class="secondary">üéõÔ∏è Mix</button>
                </div>
            `;

            return div;
        }

        // Select MKV file for mixing
        function selectMKVFile(filename) {
            selectedFile = filename;

            // Analyze the MKV file
            showAlert('Analyzing MKV file tracks...', 'info');

            fetch(`/api/mix/analyze/${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        trackAnalysis = data.analysis;
                        displayTrackMixer();
                        showAlert(`Loaded ${data.analysis.track_count} tracks from ${filename}`, 'success');

                        // Scroll to track mixer
                        document.getElementById('track-mixer').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        throw new Error(data.error || 'Failed to analyze MKV file');
                    }
                })
                .catch(error => {
                    console.error('Failed to analyze MKV file:', error);
                    showAlert('Failed to analyze MKV file: ' + error.message, 'error');
                    hideTrackMixer();
                });
        }

        // Update MKV pagination controls
        function updateMKVPagination(page, totalPages, totalItems) {
            document.getElementById('mkv-pagination-info').textContent = `Page ${page} of ${totalPages}`;
            document.getElementById('mkv-total-info').textContent = `(${totalItems} MKV files)`;

            const prevBtn = document.getElementById('mkv-prev');
            const nextBtn = document.getElementById('mkv-next');

            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= totalPages;
        }

        // MKV pagination functions
        function previousMKVPage() {
            if (currentPage > 1) {
                currentPage--;
                renderMKVList();
            }
        }

        function nextMKVPage() {
            const totalPages = Math.ceil(filteredMKVFiles.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderMKVList();
            }
        }

        // Display track mixer interface
        function displayTrackMixer() {
            const trackMixer = document.getElementById('track-mixer');
            const trackList = document.getElementById('track-list');

            trackMixer.style.display = 'block';

            // Clear existing tracks
            trackList.innerHTML = '';
            trackVolumes = {};

            if (!trackAnalysis || !trackAnalysis.tracks) {
                showAlert('No track information available', 'error');
                return;
            }

            // Create track controls
            trackAnalysis.tracks.forEach((track, index) => {
                const trackElement = createTrackElement(track, index);
                trackList.appendChild(trackElement);

                // Initialize volume
                trackVolumes[track.name || `Track ${index + 1}`] = 1.0;
            });
        }

        // Hide track mixer
        function hideTrackMixer() {
            const trackMixer = document.getElementById('track-mixer');
            trackMixer.style.display = 'none';
        }

        // Create track element with volume control
        function createTrackElement(track, index) {
            const trackName = track.name || `Track ${index + 1}`;
            const div = document.createElement('div');
            div.className = 'track-item';

            div.innerHTML = `
                <div class="track-header">
                    <h4 class="track-name">üéµ ${trackName}</h4>
                    <div class="volume-display">
                        <span class="volume-value">100%</span>
                    </div>
                </div>
                <div class="track-info">
                    <span class="track-detail">Channel: ${index + 1}</span>
                </div>
                <div class="volume-control">
                    <label for="volume-${index}" class="volume-label">Volume:</label>
                    <input type="range"
                           id="volume-${index}"
                           class="volume-slider"
                           min="0"
                           max="2"
                           step="0.1"
                           value="1.0"
                           oninput="updateTrackVolume('${trackName}', this.value, ${index})">
                    <div class="volume-labels">
                        <span>0%</span>
                        <span>100%</span>
                        <span>200%</span>
                    </div>
                </div>
            `;

            return div;
        }

        // Update track volume
        function updateTrackVolume(trackName, value, index) {
            trackVolumes[trackName] = parseFloat(value);

            // Update display
            const volumeValue = document.querySelector(`#volume-${index}`).parentNode.parentNode.querySelector('.volume-value');
            volumeValue.textContent = Math.round(value * 100) + '%';
        }

        // Reset all volumes to 100%
        function resetVolumes() {
            Object.keys(trackVolumes).forEach((trackName, index) => {
                trackVolumes[trackName] = 1.0;
                const slider = document.getElementById(`volume-${index}`);
                if (slider) {
                    slider.value = '1.0';
                    updateTrackVolume(trackName, '1.0', index);
                }
            });
            showAlert('All volumes reset to 100%', 'info');
        }

        // Create mix with current volume settings
        function createMix() {
            if (!selectedFile || !trackAnalysis) {
                showAlert('Please select an MKV file first', 'error');
                return;
            }

            const data = {
                filename: selectedFile,
                track_volumes: trackVolumes
            };

            showAlert('Creating custom mix...', 'info');

            fetch('/api/mix/render', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(`Mix created successfully: ${data.output_filename}`, 'success');

                        // Update the player with the new mix
                        setupAudioPlayer(data.output_filename, {
                            size_human: 'Just created',
                            mod_time: new Date().toLocaleString()
                        });

                        // Scroll to player
                        document.querySelector('.audio-player-section').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        throw new Error(data.error || 'Failed to create mix');
                    }
                })
                .catch(error => {
                    console.error('Failed to create mix:', error);
                    showAlert('Failed to create mix: ' + error.message, 'error');
                });
        }

        // Show alert message
        function showAlert(message, type) {
            const responseArea = document.getElementById('response-area');
            responseArea.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;

            // Auto-hide success and info messages after 5 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    responseArea.innerHTML = '';
                }, 5000);
            }
        }

        // Display track mixer interface (updated)
        function displayTrackMixer() {
            const trackMixer = document.getElementById('track-mixer');
            const trackList = document.getElementById('track-list');

            trackMixer.style.display = 'block';

            // Clear existing tracks
            trackList.innerHTML = '';
            trackVolumes = {};

            if (!trackAnalysis || !trackAnalysis.tracks) {
                showAlert('No track information available', 'error');
                return;
            }

            // Create track controls
            trackAnalysis.tracks.forEach((track, index) => {
                const trackElement = createTrackElement(track, index);
                trackList.appendChild(trackElement);

                // Initialize volume
                trackVolumes[track.name || `Track ${index + 1}`] = 1.0;
            });
        }
    </script>
</body>
</html>